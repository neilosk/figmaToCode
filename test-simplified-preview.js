#!/usr/bin/env node

/**
 * Test script for the simplified server-side preview renderer
 */

const testCases = [
  {
    name: "Claude Generated Component",
    code: `import React from 'react';

export default function TestComponent() {
  return (
    <div className="p-8 bg-blue-50 rounded-lg border-2 border-blue-200">
      <h1 className="text-2xl font-bold text-blue-800 mb-4">
        âœ… Claude Component Test
      </h1>
      <p className="text-blue-600">
        This component was generated by Claude AI
      </p>
    </div>
  );
}`,
    componentName: "TestComponent"
  },
  
  {
    name: "OpenAI Generated Component",
    code: `import React from 'react';

const OpenAIComponent: React.FC = () => {
  return (
    <div className="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden">
      <div className="p-6">
        <h2 className="text-xl font-semibold text-gray-900">OpenAI Test</h2>
        <p className="text-gray-600 mt-2">Generated by OpenAI</p>
      </div>
    </div>
  );
};

export default OpenAIComponent;`,
    componentName: "OpenAIComponent"
  },
  
  {
    name: "Gemini Generated Component",
    code: `import React from 'react';

function GeminiComponent() {
  const handleClick = () => {
    console.log('Button clicked!');
  };

  return (
    <div className="container mx-auto p-4">
      <div className="bg-gradient-to-r from-purple-400 to-pink-400 rounded-lg p-6">
        <h3 className="text-white text-lg font-bold">Gemini Generated</h3>
        <button 
          onClick={handleClick}
          className="mt-4 bg-white text-purple-600 px-4 py-2 rounded hover:bg-gray-100"
        >
          Click me
        </button>
      </div>
    </div>
  );
}

export default GeminiComponent;`,
    componentName: "GeminiComponent"
  }
];

async function testSimplifiedRenderer() {
  console.log('ğŸ§ª Testing Simplified Server-Side Renderer...\n');
  
  for (const testCase of testCases) {
    console.log(`ğŸ“ Testing: ${testCase.name}`);
    
    try {
      const response = await fetch('http://localhost:3013/api/render-component', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          code: testCase.code,
          componentName: testCase.componentName,
          styling: 'tailwind'
        })
      });
      
      if (response.ok) {
        const html = await response.text();
        console.log(`âœ… ${testCase.name}: SUCCESS (${html.length} characters)`);
        
        // Check if HTML contains expected elements
        const hasTitle = html.includes(testCase.componentName);
        const hasReact = html.includes('react');
        const hasTailwind = html.includes('tailwindcss');
        
        console.log(`   ğŸ“‹ Title: ${hasTitle ? 'âœ“' : 'âœ—'}`);
        console.log(`   âš›ï¸  React: ${hasReact ? 'âœ“' : 'âœ—'}`);
        console.log(`   ğŸ¨ Tailwind: ${hasTailwind ? 'âœ“' : 'âœ—'}`);
      } else {
        const errorText = await response.text();
        console.log(`âŒ ${testCase.name}: FAILED (${response.status})`);
        console.log(`   Error: ${errorText.substring(0, 200)}...`);
      }
    } catch (error) {
      console.log(`âŒ ${testCase.name}: ERROR`);
      console.log(`   ${error.message}`);
    }
    
    console.log(''); // Empty line
  }
}

// Check if server is running first
async function checkServer() {
  try {
    const response = await fetch('http://localhost:3013');
    return response.ok;
  } catch {
    return false;
  }
}

// Run the test
(async () => {
  const serverRunning = await checkServer();
  
  if (!serverRunning) {
    console.log('âŒ Server not running at http://localhost:3013');
    console.log('Please start the server with: npm run dev');
    process.exit(1);
  }
  
  await testSimplifiedRenderer();
  console.log('ğŸ‰ Test completed!');
})();